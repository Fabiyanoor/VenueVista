@page "/additional-services/create"
@layout AdminLayout
@using MyApp.Shared.Dtos.Venue
@inject IAdditionalServiceService AdditionalServiceService
@inject IVenueService VenueService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<div class="min-h-screen bg-gray-50 py-8">
    <div class="mx-auto max-w-2xl px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="mb-8 text-center">
            <h1 class="text-3xl font-bold text-gray-900">Create Additional Service</h1>
            <p class="mt-2 text-gray-600">Add a new service to a venue</p>
        </div>

        <!-- Form -->
        <div class="animate-slide-up rounded-lg bg-white p-6 shadow-md">
            <!-- Error Message -->
            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="mb-4 rounded-md border border-red-200 bg-red-50 p-3">
                    <p class="text-sm text-red-600">@errorMessage</p>
                </div>
            }

            @if (!string.IsNullOrEmpty(successMessage))
            {
                <div class="mb-4 rounded-md border border-green-200 bg-green-50 p-3">
                    <p class="text-sm text-green-600">@successMessage</p>
                </div>
            }

            <!-- Venue Selection -->
            <div class="mb-4">
                <label class="mb-1 block text-sm font-medium text-gray-700">Select Venue *</label>
                <select @bind="selectedVenueId" class="w-full rounded-md border border-gray-300 px-3 py-2 text-black transition-colors focus:ring-2 focus:ring-[#a0522d] focus:outline-none">
                    <option value="">Choose a venue...</option>
                    @foreach (var venue in venues)
                    {
                        <option value="@venue.Id">@venue.Name</option>
                    }
                </select>
                @if (string.IsNullOrEmpty(selectedVenueId) && isSubmitted)
                {
                    <p class="mt-1 text-sm text-red-600">Please select a venue</p>
                }
            </div>

            <!-- Service Name -->
            <div class="mb-4">
                <label class="mb-1 block text-sm font-medium text-gray-700">Service Name *</label>
                <input type="text" @bind="serviceName"
                       class="w-full rounded-md border border-gray-300 px-3 py-2 text-black transition-colors focus:ring-2 focus:ring-[#a0522d] focus:outline-none"
                       placeholder="Enter service name" />
                @if (string.IsNullOrEmpty(serviceName) && isSubmitted)
                {
                    <p class="mt-1 text-sm text-red-600">Service name is required</p>
                }
            </div>

            <!-- Description -->
            <div class="mb-4">
                <label class="mb-1 block text-sm font-medium text-gray-700">Description</label>
                <textarea @bind="description"
                          class="w-full rounded-md border border-gray-300 px-3 py-2 text-black transition-colors focus:ring-2 focus:ring-[#a0522d] focus:outline-none"
                          placeholder="Enter service description (optional)"
                          rows="3"></textarea>
            </div>

            <!-- Price -->
            <div class="mb-6">
                <label class="mb-1 block text-sm font-medium text-gray-700">Price *</label>
                <input type="number" @bind="price" step="0.01" min="0"
                       class="w-full rounded-md border border-gray-300 px-3 py-2 text-black transition-colors focus:ring-2 focus:ring-[#a0522d] focus:outline-none"
                       placeholder="Enter price" />
                @if (price <= 0 && isSubmitted)
                {
                    <p class="mt-1 text-sm text-red-600">Price must be greater than 0</p>
                }
            </div>

            <!-- Buttons -->
            <div class="flex justify-end gap-3">
                <button type="button" @onclick="Cancel"
                        class="rounded-md border border-gray-300 px-4 py-2 text-gray-700 transition-colors hover:bg-gray-50 focus:ring-2 focus:ring-[#d2a679] focus:outline-none">
                    Cancel
                </button>
                <button type="button" @onclick="HandleSubmit"
                        disabled="@isSubmitting"
                        class="rounded-md bg-[#a0522d] px-4 py-2 text-white transition-colors hover:bg-[#d2a679] focus:ring-2 focus:ring-[#d2a679] focus:outline-none disabled:opacity-50">
                    @if (isSubmitting)
                    {
                        <span class="flex items-center">
                            <svg class="mr-2 h-5 w-5 animate-spin text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            Creating...
                        </span>
                    }
                    else
                    {
                        <span>Create Service</span>
                    }
                </button>
            </div>
        </div>
    </div>
</div>

@code {
    private List<VenueDto> venues = new();
    private string selectedVenueId = string.Empty;
    private string serviceName = string.Empty;
    private string description = string.Empty;
    private decimal price = 0;
    private string errorMessage = string.Empty;
    private string successMessage = string.Empty;
    private bool isSubmitting = false;
    private bool isSubmitted = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadVenues();
    }

    private async Task LoadVenues()
    {
        try
        {
            var result = await VenueService.GetAllVenuesAsync();
            if (result.IsSuccess)
            {
                venues = result.Data.OrderBy(v => v.Name).ToList();
            }
            else
            {
                errorMessage = result.Error;
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load venues: {ex.Message}";
        }
    }

    private async Task HandleSubmit()
    {
        isSubmitted = true;
        errorMessage = string.Empty;
        successMessage = string.Empty;

        // Validation
        if (string.IsNullOrEmpty(selectedVenueId))
        {
            errorMessage = "Please select a venue";
            return;
        }

        if (string.IsNullOrEmpty(serviceName))
        {
            errorMessage = "Service name is required";
            return;
        }

        if (price <= 0)
        {
            errorMessage = "Price must be greater than 0";
            return;
        }

        isSubmitting = true;

        try
        {
            var dto = new CreateAdditionalServiceDto
            {
                VenueId = Guid.Parse(selectedVenueId),
                Name = serviceName.Trim(),
                Description = description.Trim(),
                Price = price
            };

            var result = await AdditionalServiceService.CreateAsync(dto);
            if (result.IsSuccess)
            {
                successMessage = "Service created successfully!";
                ResetForm();
                await Task.Delay(2000);
                Navigation.NavigateTo("/additional-services");
            }
            else
            {
                errorMessage = result.Error;
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"An error occurred: {ex.Message}";
        }
        finally
        {
            isSubmitting = false;
            StateHasChanged();
        }
    }

    private void ResetForm()
    {
        selectedVenueId = string.Empty;
        serviceName = string.Empty;
        description = string.Empty;
        price = 0;
        isSubmitted = false;
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/additional-services");
    }
}