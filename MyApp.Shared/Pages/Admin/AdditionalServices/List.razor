@page "/additional-services"
@layout AdminLayout
@using MyApp.Shared.Dtos.Venue
@inject IAdditionalServiceService AdditionalServiceService
@inject IVenueService VenueService
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime

<div class="min-h-screen bg-gray-50 p-4 sm:p-6">
    <div class="mx-auto max-w-7xl">
        <div class="animate-fade-in mb-6 flex flex-col items-start justify-between gap-4 md:flex-row md:items-center">
            <h1 class="text-3xl font-bold text-gray-900">Additional Services</h1>
            <button @onclick="NavigateToCreate" class="w-full rounded-md bg-[#a0522d] px-4 py-2 text-white transition-colors hover:bg-[#d2a679] focus:ring-2 focus:ring-[#d2a679] focus:outline-none md:w-auto">
                + Create Service
            </button>
        </div>

    

         

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="animate-fade-in mb-4 rounded-md border border-red-200 bg-red-50 p-3">
                <p class="text-sm text-red-600">@errorMessage</p>
            </div>
        }

        <div class="animate-slide-up hidden overflow-x-auto rounded-lg bg-white shadow-md sm:block">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-[#f5e6d3]">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-sm font-semibold text-[#3e2c24]">Service Name</th>
                        <th scope="col" class="px-6 py-3 text-left text-sm font-semibold text-[#3e2c24]">Venue</th>
                        <th scope="col" class="px-6 py-3 text-left text-sm font-semibold text-[#3e2c24]">Description</th>
                        <th scope="col" class="px-6 py-3 text-left text-sm font-semibold text-[#3e2c24]">Price</th>
                        <th scope="col" class="px-6 py-3 text-right text-sm font-semibold text-[#3e2c24]">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    @if (filteredServices == null)
                    {
                        <tr>
                            <td colspan="5" class="px-6 py-4 text-center text-sm text-gray-800">Loading...</td>
                        </tr>
                    }
                    else if (!filteredServices.Any())
                    {
                        <tr>
                            <td colspan="5" class="px-6 py-4 text-center text-sm text-gray-800">
                                @(HasActiveFilters ? "No services match your filters." : "No additional services found.")
                            </td>
                        </tr>
                    }
                    else
                    {
                        @foreach (var service in filteredServices)
                        {
                            <tr class="transition-colors hover:bg-gray-50">
                                <td class="px-6 py-4 text-sm font-medium text-gray-900">
                                    <button @onclick="() => NavigateToDetails(service.Id)" class="text-[#a0522d] hover:text-[#3e2c24] hover:underline">
                                        @service.Name
                                    </button>
                                </td>
                                <td class="px-6 py-4 text-sm text-gray-800">@service.VenueName</td>
                                <td class="px-6 py-4 text-sm text-gray-800">
                                    @(service.Description?.Length > 50 ? service.Description.Substring(0, 50) + "..." : service.Description)
                                </td>
                                <td class="px-6 py-4 text-sm font-semibold text-gray-800">$@service.Price.ToString("F2")</td>
                                <td class="px-6 py-4 text-right text-sm font-medium">
                                    <div class="flex justify-end gap-3">
                                        <button @onclick="() => NavigateToEdit(service.Id)" class="text-[#a0522d] hover:text-[#3e2c24]" title="Edit">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536M9 13l6-6 3 3-6 6H9v-3z" />
                                            </svg>
                                        </button>
                                        <button @onclick="() => DeleteService(service.Id)" class="text-red-600 hover:text-red-800" title="Delete">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                            </svg>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>

        <div class="animate-slide-up space-y-4 sm:hidden">
            @if (filteredServices == null)
            {
                <div class="rounded-lg bg-white p-4 text-center text-sm text-gray-800 shadow-md">Loading...</div>
            }
            else if (!filteredServices.Any())
            {
                <div class="rounded-lg bg-white p-4 text-center text-sm text-gray-800 shadow-md">
                    @(HasActiveFilters ? "No services match your filters." : "No additional services found.")
                </div>
            }
            else
            {
                @foreach (var service in filteredServices)
                {
                    <div class="rounded-lg border-l-4 border-[#a0522d] bg-white p-4 shadow-md transition-shadow hover:shadow-lg">
                        <div class="flex items-start justify-between">
                            <div class="min-w-0 flex-1">
                                <p class="truncate text-lg font-bold text-gray-900">
                                    <button @onclick="() => NavigateToDetails(service.Id)" class="text-[#3e2c24] hover:text-[#a0522d] hover:underline font-bold">
                                        @service.Name
                                    </button>
                                </p>
                                <p class="text-sm text-gray-500">Venue: @service.VenueName</p>
                                <p class="mt-1 text-base font-semibold text-[#a0522d]">$@service.Price.ToString("F2")</p>
                            </div>
                        </div>

                        <div class="mt-3 border-t border-gray-100 pt-3 text-sm">
                            <p class="font-medium text-gray-700">Description:</p>
                            <p class="text-gray-500">@(service.Description?.Length > 100 ? service.Description.Substring(0, 100) + "..." : (string.IsNullOrWhiteSpace(service.Description) ? "No description provided." : service.Description))</p>
                        </div>

                        <div class="mt-4 flex justify-end gap-3">
                            <button @onclick="() => NavigateToEdit(service.Id)" class="flex items-center text-[#a0522d] hover:text-[#3e2c24] text-sm font-medium" title="Edit">
                                <svg xmlns="http://www.w3.org/2000/svg" class="mr-1 h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536M9 13l6-6 3 3-6 6H9v-3z" /></svg>
                                Edit
                            </button>
                            <button @onclick="() => DeleteService(service.Id)" class="flex items-center text-red-600 hover:text-red-800 text-sm font-medium" title="Delete">
                                <svg xmlns="http://www.w3.org/2000/svg" class="mr-1 h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                                Delete
                            </button>
                        </div>
                    </div>
                }
            }
        </div>
    </div>
</div>

<style>
    /* ... (Your existing styles remain unchanged) ... */
    .animate-fade-in {
        animation: fadeIn 0.5s ease-in;
    }

    .animate-slide-up {
        animation: slideUp 0.5s ease-out;
    }

    @@keyframes fadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    @@keyframes slideUp {
        from {
            transform: translateY(20px);
            opacity: 0;
        }

        to {
            transform: translateY(0);
            opacity: 1;
        }
    }
</style>

@code {
    private List<AdditionalServiceDto> allServices = new();
    private List<AdditionalServiceDto> filteredServices = new();
    private List<VenueDto> venues = new();
    private string errorMessage = string.Empty;
    private string selectedVenueId = string.Empty;
    private string searchTerm = string.Empty;
    private string priceRange = "all";

    private bool HasActiveFilters => !string.IsNullOrEmpty(selectedVenueId) || !string.IsNullOrEmpty(searchTerm) || priceRange != "all";

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    protected override void OnParametersSet()
    {
        // This is only necessary if parameters were passed, but we apply filters on bound value changes anyway.
        // It's still a good habit if the filter logic is complex.
        // For simple @bind, the OnInitializedAsync's LoadData (which calls ApplyFilters) is often enough.
        // We ensure filtering runs if inputs (bound properties) change.
        ApplyFilters();
    }

    private async Task LoadData()
    {
        try
        {
            // Load services
            var servicesResult = await AdditionalServiceService.GetAllAsync();
            if (servicesResult.IsSuccess)
            {
                allServices = servicesResult.Data;
            }
            else
            {
                errorMessage = servicesResult.Error;
                allServices = new List<AdditionalServiceDto>();
            }

            // Load venues for filter dropdown
            var venuesResult = await VenueService.GetAllVenuesAsync();
            if (venuesResult.IsSuccess)
            {
                venues = venuesResult.Data.OrderBy(v => v.Name).ToList();
            }
            else
            {
                // Fallback: extract venues from services
                venues = allServices
                    .GroupBy(s => new { s.VenueId, s.VenueName })
                    .Select(g => new VenueDto { Id = g.Key.VenueId, Name = g.Key.VenueName })
                    .OrderBy(v => v.Name)
                    .ToList();
            }

            ApplyFilters();
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load data: {ex.Message}";
        }
    }

    private void ApplyFilters()
    {
        if (allServices == null) return;

        var query = allServices.AsEnumerable();

        // Venue filter
        if (!string.IsNullOrEmpty(selectedVenueId))
        {
            if (Guid.TryParse(selectedVenueId, out var venueId))
            {
                query = query.Where(s => s.VenueId == venueId);
            }
        }

        // Search filter
        if (!string.IsNullOrEmpty(searchTerm))
        {
            query = query.Where(s => s.Name.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                                     (s.Description != null && s.Description.Contains(searchTerm, StringComparison.OrdinalIgnoreCase)));
        }

        // Price range filter
        switch (priceRange)
        {
            case "0-50":
                query = query.Where(s => s.Price <= 50);
                break;
            case "51-100":
                query = query.Where(s => s.Price > 50 && s.Price <= 100);
                break;
            case "101-200":
                query = query.Where(s => s.Price > 100 && s.Price <= 200);
                break;
            case "201+":
                query = query.Where(s => s.Price > 200);
                break;
        }

        filteredServices = query.OrderBy(s => s.VenueName).ThenBy(s => s.Name).ToList();
        StateHasChanged();
    }

    private void ClearVenueFilter()
    {
        selectedVenueId = string.Empty;
        ApplyFilters();
    }

    private void ClearSearch()
    {
        searchTerm = string.Empty;
        ApplyFilters();
    }

    private void ClearPriceRange()
    {
        priceRange = "all";
        ApplyFilters();
    }

    private void ClearAllFilters()
    {
        selectedVenueId = string.Empty;
        searchTerm = string.Empty;
        priceRange = "all";
        ApplyFilters();
    }

    private void NavigateToCreate()
    {
        NavigationManager.NavigateTo("/additional-services/create");
    }

    private void NavigateToDetails(Guid serviceId)
    {
        NavigationManager.NavigateTo($"/additional-services/{serviceId}");
    }

    private void NavigateToEdit(Guid serviceId)
    {
        NavigationManager.NavigateTo($"/additional-services/{serviceId}/edit");
    }

    private async Task DeleteService(Guid serviceId)
    {
        bool confirm = await JSRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to delete this service?");
        if (!confirm) return;

        try
        {
            var result = await AdditionalServiceService.DeleteAsync(serviceId);
            if (result.IsSuccess)
            {
                await LoadData();
            }
            else
            {
                errorMessage = result.Error;
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to delete service: {ex.Message}";
        }
        StateHasChanged();
    }
}