@page "/admin/packages"
@layout AdminLayout
@using MyApp.Shared.Dtos.Venue
@inject IVenuePackageService PackageService
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime

<div class="min-h-screen bg-gray-50 p-4 sm:p-6">
    <div class="mx-auto max-w-7xl">
        <div class="animate-fade-in mb-6 flex flex-col items-start justify-between gap-4 md:flex-row md:items-center">
            <h1 class="text-3xl font-bold text-gray-900">Packages</h1>
            <button @onclick="NavigateToCreatePackage" class="w-full rounded-md bg-[#a0522d] px-4 py-2 text-white transition-colors hover:bg-[#d2a679] focus:ring-2 focus:ring-[#d2a679] focus:outline-none md:w-auto">
                + Create Package
            </button>
        </div>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="animate-fade-in mb-4 rounded-md border border-red-200 bg-red-50 p-3">
                <p class="text-sm text-red-600">@errorMessage</p>
            </div>
        }

        <div class="animate-slide-up overflow-x-auto rounded-lg bg-white shadow-md">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-[#f5e6d3]">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-sm font-semibold text-[#3e2c24]">Venue</th>
                        <th scope="col" class="px-6 py-3 text-left text-sm font-semibold text-[#3e2c24]">Name</th>
                        <th scope="col" class="px-6 py-3 text-left text-sm font-semibold text-[#3e2c24]">Tier</th>
                        <th scope="col" class="px-6 py-3 text-left text-sm font-semibold text-[#3e2c24]">Base Price</th>
                        <th scope="col" class="px-6 py-3 text-right text-sm font-semibold text-[#3e2c24]">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    @if (packages == null)
                    {
                        <tr>
                            <td colspan="5" class="px-6 py-4 text-center text-sm text-gray-800">Loading...</td>
                        </tr>
                    }
                    else if (!packages.Any())
                    {
                        <tr>
                            <td colspan="5" class="px-6 py-4 text-center text-sm text-gray-800">No packages found.</td>
                        </tr>
                    }
                    else
                    {
                        @foreach (var package in packages)
                        {
                            <tr class="transition-colors hover:bg-gray-50">
                                <td class="px-6 py-4 text-sm text-gray-800">@package.VenueName</td>
                                <td class="px-6 py-4 text-sm font-medium text-gray-800">@package.Name</td>
                                <td class="px-6 py-4 text-sm text-gray-800">@package.Tier</td>
                                <td class="px-6 py-4 text-sm font-semibold text-gray-800">$@package.BasePrice</td>
                                <td class="px-6 py-4 text-right text-sm font-medium">
                                    <div class="flex justify-end gap-3">
                                        <button @onclick="() => NavigateToViewPackage(package.Id)" class="text-[#a0522d] hover:text-[#3e2c24]" title="View">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                            </svg>
                                        </button>
                                        <button @onclick="() => NavigateToEditPackage(package.Id)" class="text-[#a0522d] hover:text-[#3e2c24]" title="Edit">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536M9 13l6-6 3 3-6 6H9v-3z" />
                                            </svg>
                                        </button>
                                        <button @onclick="() => DeletePackage(package.Id)" class="text-red-600 hover:text-red-800" title="Delete">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                            </svg>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@code {
    private List<VenuePackageDto> packages = null;
    private string errorMessage = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadPackages();
    }

    private async Task LoadPackages()
    {
        try
        {
            var result = await PackageService.GetAllPackagesAsync();
            if (result.IsSuccess)
            {
                packages = result.Data;
            }
            else
            {
                errorMessage = result.Error;
                packages = new List<VenuePackageDto>();
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load packages: {ex.Message}";
            packages = new List<VenuePackageDto>();
        }
        StateHasChanged();
    }

    private void NavigateToCreatePackage()
    {
        NavigationManager.NavigateTo("/admin/packages/create");
    }

    private void NavigateToViewPackage(Guid packageId)
    {
        NavigationManager.NavigateTo($"/admin/packages/{packageId}");
    }

    private void NavigateToEditPackage(Guid packageId)
    {
        NavigationManager.NavigateTo($"/admin/packages/{packageId}/edit");
    }

    private async Task DeletePackage(Guid packageId)
    {
        bool confirm = await JSRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to delete this package?");
        if (!confirm) return;
        try
        {
            var result = await PackageService.DeletePackageAsync(packageId);
            if (result.IsSuccess)
            {
                await LoadPackages();
            }
            else
            {
                errorMessage = result.Error;
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to delete package: {ex.Message}";
        }
        StateHasChanged();
    }
}