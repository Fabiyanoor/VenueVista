@page "/packages"
@layout MainLayout
@using MyApp.Shared.Dtos.Venue
@using MyApp.Shared.Dtos.VenuePackage
@inject IVenuePackageService PackageService
@inject NavigationManager NavigationManager

<div class="min-h-screen bg-gray-50">
    <!-- Search Bar Section -->
    <div class="border-b border-gray-200 bg-white shadow-sm">
        <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
            <div class="flex h-16 items-center justify-between">
                <div class="flex flex-1 items-center space-x-4">
                    <div class="max-w-lg flex-1">
                        <div class="relative flex gap-2">
                            <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                                <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                </svg>
                            </div>
                            <input @bind="searchTerm"
                                   @oninput="OnSearchInput"
                                   type="text"
                                   class="placeholder-gray-500 block w-full rounded-lg border border-gray-300 bg-white py-2 pr-3 pl-10 text-sm text-black focus:border-[#a0522d] focus:ring-1 focus:ring-[#a0522d] focus:outline-none"
                                   placeholder="Search packages..." />
                            <button @onclick="ApplyFilters"
                                    class="rounded-lg bg-[#a0522d] px-4 py-2 text-sm font-medium text-white transition-colors hover:bg-[#8b4513] focus:ring-2 focus:ring-[#a0522d] focus:ring-offset-2 focus:outline-none">
                                Search
                            </button>
                        </div>
                    </div>

                    <button @onclick="NavigateToVenues"
                            class="rounded-lg bg-[#a0522d] px-4 py-2 text-sm font-medium text-white transition-colors hover:bg-[#8b4513] focus:ring-2 focus:ring-[#a0522d] focus:ring-offset-2 focus:outline-none">
                        View Venues
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="mx-auto max-w-7xl px-4 py-8 sm:px-6 lg:px-8">
        <div class="flex flex-col gap-8 lg:flex-row">
            <!-- Filters Sidebar -->
            <div class="w-full flex-shrink-0 lg:w-80">
                <div class="sticky top-8 rounded-lg bg-white p-6 shadow-sm">
                    <div class="mb-6 flex items-center justify-between">
                        <h2 class="text-lg font-semibold text-gray-900">Filters</h2>
                        <button @onclick="ClearAllFilters" class="text-sm text-[#a0522d] hover:text-[#8b4513]">
                            Clear All
                        </button>
                    </div>

                    <!-- Price Range -->
                    <div class="mb-6">
                        <h3 class="mb-3 text-sm font-medium text-gray-900">Price Range</h3>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-xs text-gray-600">Min: $@minPrice</label>
                                <input type="range" min="@(filterOptions?.PriceRange?.Min ?? 0)"
                                       max="@(filterOptions?.PriceRange?.Max ?? 10000)"
                                       @bind="minPrice"
                                       @oninput="OnPriceInput"
                                       class="h-2 w-full cursor-pointer appearance-none rounded-lg bg-gray-200 [&::-webkit-slider-thumb]:h-4 [&::-webkit-slider-thumb]:w-4 [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:bg-[#a0522d]" />
                            </div>
                            <div>
                                <label class="block text-xs text-gray-600">Max: $@maxPrice</label>
                                <input type="range" min="@(filterOptions?.PriceRange?.Min ?? 0)"
                                       max="@(filterOptions?.PriceRange?.Max ?? 10000)"
                                       @bind="maxPrice"
                                       @oninput="OnPriceInput"
                                       class="h-2 w-full cursor-pointer appearance-none rounded-lg bg-gray-200 [&::-webkit-slider-thumb]:h-4 [&::-webkit-slider-thumb]:w-4 [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:bg-[#a0522d]" />
                            </div>
                        </div>
                    </div>

                    <!-- Capacity Range -->
                    <div class="mb-6">
                        <h3 class="mb-3 text-sm font-medium text-gray-900">Capacity Range</h3>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-xs text-gray-600">Min: @minCapacity guests</label>
                                <input type="range" min="@(filterOptions?.CapacityRange?.Min ?? 0)"
                                       max="@(filterOptions?.CapacityRange?.Max ?? 1000)"
                                       @bind="minCapacity"
                                       @oninput="OnCapacityInput"
                                       class="h-2 w-full cursor-pointer appearance-none rounded-lg bg-gray-200 [&::-webkit-slider-thumb]:h-4 [&::-webkit-slider-thumb]:w-4 [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:bg-[#a0522d]" />
                            </div>
                            <div>
                                <label class="block text-xs text-gray-600">Max: @maxCapacity guests</label>
                                <input type="range" min="@(filterOptions?.CapacityRange?.Min ?? 0)"
                                       max="@(filterOptions?.CapacityRange?.Max ?? 1000)"
                                       @bind="maxCapacity"
                                       @oninput="OnCapacityInput"
                                       class="h-2 w-full cursor-pointer appearance-none rounded-lg bg-gray-200 [&::-webkit-slider-thumb]:h-4 [&::-webkit-slider-thumb]:w-4 [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:bg-[#a0522d]" />
                            </div>
                        </div>
                    </div>

                    <!-- Package Tiers -->
                    <div class="mb-6">
                        <h3 class="mb-3 text-sm font-medium text-gray-900">Package Tiers</h3>
                        <div class="max-h-40 space-y-2 overflow-y-auto">
                            @if (filterOptions?.Tiers != null)
                            {
                                @foreach (var tier in filterOptions.Tiers)
                                {
                                    <label class="flex items-center rounded px-2 py-1 hover:bg-gray-50">
                                        <input type="checkbox" checked="@selectedTiers.Contains(tier.Tier)"
                                               @onchange="@((e) => ToggleTier(tier.Tier, (bool)e.Value))"
                                               class="h-4 w-4 rounded border-gray-300 text-[#a0522d] focus:ring-[#a0522d]" />
                                        <span class="ml-2 text-sm text-gray-700">
                                            @tier.Name <span class="text-xs text-gray-500">(@tier.Count)</span>
                                        </span>
                                    </label>
                                }
                            }
                        </div>
                    </div>

                    <div class="border-t border-gray-200 pt-4">
                        <p class="text-sm text-gray-600">
                            Showing <span class="font-semibold">@filteredPackages?.Count</span> packages
                        </p>
                    </div>
                </div>
            </div>

            <!-- Packages Grid -->
            <div class="flex-1">
                <h1 class="mb-8 text-3xl font-bold text-gray-900">Explore Packages</h1>

                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <div class="mb-6 rounded-md border border-red-200 bg-red-50 p-4">
                        <p class="text-sm text-red-700">@errorMessage</p>
                    </div>
                }

                <div class="grid grid-cols-1 gap-6 md:grid-cols-2 xl:grid-cols-3">
                    @if (filteredPackages == null)
                    {
                        <!-- Loading -->
                        @for (int i = 0; i < 6; i++)
                        {
                            <div class="rounded-lg bg-white p-6 shadow-md">
                                <div class="animate-pulse">
                                    <div class="mb-2 h-6 w-3/4 rounded bg-gray-200"></div>
                                    <div class="mb-4 h-4 w-1/2 rounded bg-gray-200"></div>
                                    <div class="mb-2 h-4 w-full rounded bg-gray-200"></div>
                                    <div class="mb-4 h-4 w-5/6 rounded bg-gray-200"></div>
                                    <div class="ml-auto h-10 w-1/3 rounded bg-gray-200"></div>
                                </div>
                            </div>
                        }
                    }
                    else if (!filteredPackages.Any())
                    {
                        <div class="col-span-full rounded-lg bg-white p-12 text-center shadow-sm">
                            <svg class="mx-auto mb-4 h-16 w-16 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <h3 class="mb-2 text-lg font-medium text-gray-900">No packages found</h3>
                            <p class="mb-4 text-sm text-gray-500">Try adjusting your filters or search terms.</p>
                            <button @onclick="ClearAllFilters" class="inline-flex items-center rounded-md bg-[#a0522d] px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-[#8b4513]">
                                Clear all filters
                            </button>
                        </div>
                    }
                    else
                    {
                        @foreach (var package in filteredPackages)
                        {
                            <div class="rounded-lg border border-gray-100 bg-white p-6 shadow-md transition-all hover:shadow-lg">
                                <div class="mb-3 flex items-start justify-between">
                                    <h2 class="text-xl font-semibold text-gray-900">@package.Name</h2>
                                    <span class="inline-flex items-center rounded-full bg-[#a0522d] px-2.5 py-0.5 text-xs font-medium text-white">
                                        @package.Tier
                                    </span>
                                </div>
                                <p class="mb-2 text-sm font-medium text-gray-600">@package.VenueName</p>
                                <p class="mb-3 text-2xl font-bold text-[#a0522d]">$@package.BasePrice</p>
                                <p class="mb-2 text-sm text-gray-600">Capacity: @package.BaseCapacity guests</p>
                                <p class="mb-4 line-clamp-3 text-sm text-gray-700">
                                    @(string.IsNullOrEmpty(package.Description) ? "No description available" : package.Description)
                                </p>
                                <div class="flex justify-end">
                                    <button @onclick="() => NavigateToDetails(package.Id)"
                                            class="rounded-md bg-[#a0522d] px-4 py-2 text-sm font-medium text-white transition-colors hover:bg-[#8b4513]">
                                        View Details
                                    </button>
                                </div>
                            </div>
                        }
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private List<VenuePackageDto> packages = new();
    private List<VenuePackageDto> filteredPackages = new();
    private PackageFilterOptionsDto? filterOptions;
    private string errorMessage = string.Empty;

    private string searchTerm = "";
    private decimal minPrice = 0;
    private decimal maxPrice = 10000;
    private int minCapacity = 0;
    private int maxCapacity = 1000;
    private List<PackageTier> selectedTiers = new();
    private System.Threading.Timer? searchTimer;
    private System.Threading.Timer? priceTimer;
    private System.Threading.Timer? capacityTimer;

    protected override async Task OnInitializedAsync()
    {
        await LoadPackages();
        await LoadFilterOptions();
        ApplyFilters();
    }

    private async Task LoadPackages()
    {
        try
        {
            var result = await PackageService.GetAllPackagesAsync();
            if (result.IsSuccess)
            {
                packages = result.Data;
            }
            else
            {
                errorMessage = result.Error;
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load packages: {ex.Message}";
        }
    }

    private async Task LoadFilterOptions()
    {
        try
        {
            var result = await PackageService.GetFilterOptionsAsync();
            if (result.IsSuccess)
            {
                filterOptions = result.Data;
                minPrice = filterOptions?.PriceRange?.Min ?? 0;
                maxPrice = filterOptions?.PriceRange?.Max ?? 10000;
                minCapacity = filterOptions?.CapacityRange?.Min ?? 0;
                maxCapacity = filterOptions?.CapacityRange?.Max ?? 1000;
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load filter options: {ex.Message}";
        }
    }

    private void ApplyFilters()
    {
        if (packages == null) return;

        var filtered = packages.AsEnumerable();

        // Apply search
        if (!string.IsNullOrWhiteSpace(searchTerm))
        {
            var search = searchTerm.ToLower();
            filtered = filtered.Where(p =>
                p.Name.ToLower().Contains(search) ||
                (p.Description != null && p.Description.ToLower().Contains(search)) ||
                p.VenueName.ToLower().Contains(search) ||
                p.Tier.ToString().ToLower().Contains(search)
            );
        }

        // Apply price range
        filtered = filtered.Where(p => p.BasePrice >= minPrice && p.BasePrice <= maxPrice);

        // Apply capacity range
        filtered = filtered.Where(p => p.BaseCapacity >= minCapacity && p.BaseCapacity <= maxCapacity);

        // Apply tier filter
        if (selectedTiers.Any())
        {
            filtered = filtered.Where(p => selectedTiers.Contains(p.Tier));
        }

        filteredPackages = filtered.ToList();
        StateHasChanged();
    }

    private void OnSearchInput(ChangeEventArgs e)
    {
        searchTerm = e.Value?.ToString() ?? "";
        // Debounce search - apply filters after 500ms of no typing
        searchTimer?.Dispose();
        searchTimer = new System.Threading.Timer(_ =>
        {
            InvokeAsync(ApplyFilters);
        }, null, 500, Timeout.Infinite);
    }

    private void OnPriceInput(ChangeEventArgs e)
    {
        // Debounce price changes - apply filters after 300ms
        priceTimer?.Dispose();
        priceTimer = new System.Threading.Timer(_ =>
        {
            InvokeAsync(ApplyFilters);
        }, null, 300, Timeout.Infinite);
    }

    private void OnCapacityInput(ChangeEventArgs e)
    {
        // Debounce capacity changes - apply filters after 300ms
        capacityTimer?.Dispose();
        capacityTimer = new System.Threading.Timer(_ =>
        {
            InvokeAsync(ApplyFilters);
        }, null, 300, Timeout.Infinite);
    }

    private void ToggleTier(PackageTier tier, bool isSelected)
    {
        if (isSelected)
            selectedTiers.Add(tier);
        else
            selectedTiers.Remove(tier);
        ApplyFilters();
    }

    private void ClearAllFilters()
    {
        searchTerm = "";
        minPrice = filterOptions?.PriceRange?.Min ?? 0;
        maxPrice = filterOptions?.PriceRange?.Max ?? 10000;
        minCapacity = filterOptions?.CapacityRange?.Min ?? 0;
        maxCapacity = filterOptions?.CapacityRange?.Max ?? 1000;
        selectedTiers.Clear();
        ApplyFilters();
    }

    private void NavigateToDetails(Guid packageId)
    {
        NavigationManager.NavigateTo($"/packages/{packageId}");
    }

    private void NavigateToVenues()
    {
        NavigationManager.NavigateTo("/Menu");
    }

    public void Dispose()
    {
        searchTimer?.Dispose();
        priceTimer?.Dispose();
        capacityTimer?.Dispose();
    }
}